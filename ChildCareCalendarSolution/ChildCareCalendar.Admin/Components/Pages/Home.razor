@page "/"
@rendermode InteractiveServer
@using ChildCareCalendar.Domain.Entities
@using ChildCareCalendar.Infrastructure.Services
@using ChildCareCalendar.Infrastructure.Services.Interfaces
@inject IAppointmentService AppointmentService
@inject IJSRuntime JSRuntime

<PageTitle>Appointments Dashboard</PageTitle>

<div class="pc-content">
    <div class="row">
        <!-- Today's Appointments Card -->
        <div class="col-md-6 col-xxl-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="avtar avtar-s bg-light-primary">
                                <!-- Calendar icon -->
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M8 2V5" stroke="#4680FF" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M16 2V5" stroke="#4680FF" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                                    <path opacity="0.4" d="M3.5 9.08984H20.5" stroke="#4680FF" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M21 8.5V17C21 20 19.5 22 16 22H8C4.5 22 3 20 3 17V8.5C3 5.5 4.5 3.5 8 3.5H16C19.5 3.5 21 5.5 21 8.5Z" stroke="#4680FF" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                                    <path opacity="0.4" d="M11.9955 13.7002H12.0045" stroke="#4680FF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">Today's Appointments</h6>
                        </div>
                        <div class="flex-shrink-0 ms-3">
                            <div class="dropdown">
                                <a class="avtar avtar-s btn-link-secondary dropdown-toggle arrow-none"
                                   href="#"
                                   data-bs-toggle="dropdown"
                                   aria-haspopup="true"
                                   aria-expanded="false">
                                    <i class="ti ti-dots-vertical f-18"></i>
                                </a>
                                <div class="dropdown-menu dropdown-menu-end">
                                    <a class="dropdown-item" href="#">Refresh</a>
                                    <a class="dropdown-item" href="#">View All</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-body p-3 mt-3 rounded">
                        <div class="mt-3 row align-items-center">
                            <div class="col-7">
                                <div id="daily-appointment-graph"></div>
                            </div>
                            <div class="col-5">
                                <h5 class="mb-1">@todayAppointmentsCount</h5>
                                <p class="text-primary mb-0"><i class="ti ti-calendar"></i> Today</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Appointments Card -->
        <div class="col-md-6 col-xxl-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="avtar avtar-s bg-light-warning">
                                <!-- Week icon -->
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M21 7V17C21 20 19.5 22 16 22H8C4.5 22 3 20 3 17V7C3 4 4.5 2 8 2H16C19.5 2 21 4 21 7Z" stroke="#E58A00" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                                    <path opacity="0.6" d="M8 13H12" stroke="#E58A00" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                                    <path opacity="0.6" d="M8 17H16" stroke="#E58A00" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">This Week's Appointments</h6>
                        </div>
                        <div class="flex-shrink-0 ms-3">
                            <div class="dropdown">
                                <a class="avtar avtar-s btn-link-secondary dropdown-toggle arrow-none"
                                   href="#"
                                   data-bs-toggle="dropdown"
                                   aria-haspopup="true"
                                   aria-expanded="false">
                                    <i class="ti ti-dots-vertical f-18"></i>
                                </a>
                                <div class="dropdown-menu dropdown-menu-end">
                                    <a class="dropdown-item" href="#">Refresh</a>
                                    <a class="dropdown-item" href="#">View All</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-body p-3 mt-3 rounded">
                        <div class="mt-3 row align-items-center">
                            <div class="col-7">
                                <div id="weekly-appointment-graph"></div>
                            </div>
                            <div class="col-5">
                                <h5 class="mb-1">@weeklyAppointmentsCount</h5>
                                <p class="text-warning mb-0"><i class="ti ti-calendar-week"></i> This Week</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Appointments Card -->
        <div class="col-md-6 col-xxl-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="avtar avtar-s bg-light-success">
                                <!-- Month icon -->
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M8 2V5" stroke="#2ca87f" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M16 2V5" stroke="#2ca87f" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                                    <path opacity="0.4" d="M3.5 9.08984H20.5" stroke="#2ca87f" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M21 8.5V17C21 20 19.5 22 16 22H8C4.5 22 3 20 3 17V8.5C3 5.5 4.5 3.5 8 3.5H16C19.5 3.5 21 5.5 21 8.5Z" stroke="#2ca87f" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">Monthly Appointments</h6>
                        </div>
                        <div class="flex-shrink-0 ms-3">
                            <div class="dropdown">
                                <a class="avtar avtar-s btn-link-secondary dropdown-toggle arrow-none"
                                   href="#"
                                   data-bs-toggle="dropdown"
                                   aria-haspopup="true"
                                   aria-expanded="false">
                                    <i class="ti ti-dots-vertical f-18"></i>
                                </a>
                                <div class="dropdown-menu dropdown-menu-end">
                                    <a class="dropdown-item" href="#">Refresh</a>
                                    <a class="dropdown-item" href="#">View All</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-body p-3 mt-3 rounded">
                        <div class="mt-3 row align-items-center">
                            <div class="col-7">
                                <div id="monthly-appointment-graph"></div>
                            </div>
                            <div class="col-5">
                                <h5 class="mb-1">@monthlyAppointmentsCount</h5>
                                <p class="text-success mb-0"><i class="ti ti-calendar-stats"></i> This Month</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Appointments by Status Card -->
        <div class="col-md-6 col-xxl-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="avtar avtar-s bg-light-danger">
                                <!-- Status icon -->
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="#DC2626" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                                    <path opacity="0.4" d="M8.4707 10.7402L12.0007 14.2602L15.5307 10.7402" stroke="#DC2626" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">Appointments by Status</h6>
                        </div>
                        <div class="flex-shrink-0 ms-3">
                            <div class="dropdown">
                                <a class="avtar avtar-s btn-link-secondary dropdown-toggle arrow-none"
                                   href="#"
                                   data-bs-toggle="dropdown"
                                   aria-haspopup="true"
                                   aria-expanded="false">
                                    <i class="ti ti-dots-vertical f-18"></i>
                                </a>
                                <div class="dropdown-menu dropdown-menu-end">
                                    <a class="dropdown-item" href="#">Refresh</a>
                                    <a class="dropdown-item" href="#">View All</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-body p-3 mt-3 rounded">
                        <div class="mt-3 row align-items-center">
                            <div class="col-7">
                                <div id="status-appointment-graph"></div>
                            </div>
                            <div class="col-5">
                                <h5 class="mb-1">@totalAppointmentsCount</h5>
                                <p class="text-danger mb-0"><i class="ti ti-chart-pie"></i> Total</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Appointment Trend Graph -->
        <div class="col-lg-9 m-auto">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <div class="flex-grow-1">
                            <h5 class="mb-0">Appointment Trends</h5>
                        </div>
                        <div class="flex-shrink-0 ms-3">
                            <div class="dropdown">
                                <a class="avtar avtar-s btn-link-secondary dropdown-toggle arrow-none"
                                   href="#"
                                   data-bs-toggle="dropdown"
                                   aria-haspopup="true"
                                   aria-expanded="false">
                                    <i class="ti ti-dots f-18"></i>
                                </a>
                                <div class="dropdown-menu dropdown-menu-end">
                                    <a class="dropdown-item" href="#">Today</a>
                                    <a class="dropdown-item" href="#">Weekly</a>
                                    <a class="dropdown-item" href="#">Monthly</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="appointment-trend-graph"></div>
                </div>
            </div>
        </div>

        <!-- Appointment Overview -->
        <div class="col-lg-9 m-auto">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <h5 class="mb-0">Appointment overview</h5>
                        <div class="dropdown">
                            <a class="avtar avtar-s btn-link-secondary dropdown-toggle arrow-none"
                               href="#"
                               data-bs-toggle="dropdown"
                               aria-haspopup="true"
                               aria-expanded="false">
                                <i class="ti ti-dots f-18"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-end">
                                <a class="dropdown-item" href="#">Today</a>
                                <a class="dropdown-item" href="#">Weekly</a>
                                <a class="dropdown-item" href="#">Monthly</a>
                            </div>
                        </div>
                    </div>
                    <div class="row align-items-center justify-content-center">
                        <div class="col-md-6 col-xl-4">
                            <div class="mt-3 row align-items-center">
                                <div class="col-6">
                                    <p class="text-muted mb-1">Total Appointments</p>
                                    <h5 class="mb-0">@totalAppointmentsCount</h5>
                                </div>
                                <div class="col-6">
                                    <div id="total-appointment-graph"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-xl-4">
                            <div class="mt-3 row align-items-center">
                                <div class="col-6">
                                    <p class="text-muted mb-1">Pending Appointments</p>
                                    <h5 class="mb-0">@pendingAppointmentsCount</h5>
                                </div>
                                <div class="col-6">
                                    <div id="pending-appointment-graph"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-xl-4">
                            <div class="mt-3 d-grid">
                                <button class="btn btn-primary d-flex align-items-center justify-content-center gap-2">
                                    <i class="ti ti-plus"></i> Add appointment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private int todayAppointmentsCount;
    private int weeklyAppointmentsCount;
    private int monthlyAppointmentsCount;
    private int totalAppointmentsCount;
    private int pendingAppointmentsCount;
    private Dictionary<string, int> appointmentsByStatus;
    private Dictionary<DateTime, int> appointmentTrends;
    private Dictionary<int, int> appointmentsByHour;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        todayAppointmentsCount = await AppointmentService.GetTodayAppointmentsCountAsync();
        weeklyAppointmentsCount = await AppointmentService.GetWeekAppointmentsCountAsync();
        monthlyAppointmentsCount = await AppointmentService.GetMonthAppointmentsCountAsync();

        appointmentsByStatus = await AppointmentService.GetAppointmentsByStatusAsync();
        totalAppointmentsCount = appointmentsByStatus.Values.Sum();
        pendingAppointmentsCount = appointmentsByStatus.TryGetValue("ORDERED", out int pendingCount) ? pendingCount : 0;

        var today = DateTime.Today;
        var startDate = today.AddDays(-30);
        appointmentTrends = await AppointmentService.GetAppointmentsByDateRangeAsync(startDate, today);

        appointmentsByHour = await AppointmentService.GetTodayAppointmentsByHourAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeChartsAsync();
        }
    }

    private async Task InitializeChartsAsync()
    {
        // You'll need to create JS functions to initialize the charts with your data
        await JSRuntime.InvokeVoidAsync("initializeAppointmentDashboard",
            appointmentsByHour,
            appointmentTrends,
            appointmentsByStatus,
            new { today = todayAppointmentsCount, weekly = weeklyAppointmentsCount, monthly = monthlyAppointmentsCount, total = totalAppointmentsCount, pending = pendingAppointmentsCount }
        );
    }
}